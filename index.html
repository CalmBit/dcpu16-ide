<!DOCTYPE html>
<!--
	-- TODO --
	* order of operations bug
	* readme
	* splash screen in emulator
	* blinking characters
	* memory window scrolling (and coloration?)
	* better error messages for assembly exceptions
	* display CPU cycles when running
	* load files from POST body
	* maybe a way to save files?  use reddis? :)
	* maybe make the theme look more like a spaceship?
	* refactor UI code into separate JS objects / files
	* set breakpoints in editor
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<link type="text/css" href="stylesheets/custom-theme/jquery-ui-1.8.20.custom.css" rel="stylesheet" />
		<link type="text/css" href="stylesheets/styles.css" rel="stylesheet" />
		<script type="text/javascript" src="javascript/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="javascript/jquery-ui-1.8.20.custom.min.js"></script>
		<script type="text/javascript" src="javascript/emulator.js"></script>
		<script type="text/javascript" src="javascript/assembler.js"></script>
		<script type="text/javascript" src="javascript/lem1820.js"></script>
		<script type="text/javascript" src="javascript/keyboard.js"></script>
		<script type="text/javascript" src="javascript/clock.js"></script>
		<script type="text/javascript" src="javascript/ace/ace-uncompressed.js" charset="utf-8"></script>
		<script type="text/javascript" src="javascript/ace/theme-monokai.js" charset="utf-8"></script>
		<script type="text/javascript" src="javascript/ace/mode-dcpu16.js" charset="utf-8"></script>
		 
		
		<script>
			var listing;
			var emulator;
			var editor;
			var _debugger;
			
			function init() {
				editor = ace.edit("editor");
				editor.setTheme("ace/theme/monokai");
				var DCPU16Mode = require("ace/mode/dcpu16").Mode;
				editor.getSession().setMode(new DCPU16Mode());
				editor.setHighlightActiveLine(false);
				editor.resize();
				editor.getSession().setUseSoftTabs(true);
				editor.getSession().on('change', function() { 
					assemble();
				});
				/*
				editor.on("guttermousedown", function(e){
					console.log(e);
					var target = e.domEvent.target;
					if (target.className.indexOf("ace_gutter-cell") == -1)
						return;
					if (!editor.isFocused())
						return;
					if (e.clientX > 25 + target.getBoundingClientRect().left)
						return;

					var row = e.getDocumentPosition().row
					e.editor.session.setBreakpoint(row)
					e.stop()
				});
				*/
				
				
				
			
				emulator = new Emulator();
				emulator.async = true;
				emulator.verbose = false;
				var m = new Monitor(emulator);
				document.getElementById("monitor").appendChild(m.getDOMElement());
				
				emulator.devices.push(m);
				emulator.devices.push(new Keyboard(emulator));
				
				_debugger = new Debugger(emulator);
				_debugger.onStep = function(location) {
					console.log("onStep");
					updateDebugger(location);
				};
				_debugger.onPaused = function(location) {
					console.log("onPaused");
					updateDebugger(location);
				};
				_debugger.onInstruction = function(location) {
					updateDebuggerLine();
				}
				
				
				$.ajax({
					url: 			"/programs/tetris.asm",
					context:		this,
					dataType: 		"text",
					success: 		function(data) { 
						editor.getSession().setValue(data);
					}
				});
				
			}
			
			function assemble() {
				var tokenized = Tokenizer.tokenize(editor.getSession().getValue());
				listing = Assembler.compile(tokenized.lines);
				
				var errors = (new Array()).concat(tokenized.errors, listing.errors);
				
				//$("#assembly").html(listing.htmlFormat());
				
				if(errors.length == 0) {
					$("#assembly").html("OK");
					$("#assembly").css("background", "none");
				}
				else {
					$("#assembly").css("background", "#bc3329");
					var str = "";
					for(var i = 0; i < errors.length; i++) {
						str += "<div onclick='gotoLine("+errors[i].line+")' style='padding: 4px; margin-bottom: 3px; cursor: pointer;'>";
						str += "Line " + errors[i].line + ": ";
						str += errors[i].message;
						str += "</div>";
					}
					$("#assembly").html(str);
				}
				
				$("#output").html(listing.bytecodeText());
			}
			
			function gotoLine(line) {
				editor.gotoLine(line);
				editor.focus();
			}
			
			function startDebugger() {
				$("#assemble_button").hide();
				$("#debug_button").hide();
			
				$("#run_button").show();
				$("#step_button").show();
				$("#pause_button").show();
				$("#stop_button").show();
				$("#reset_button").show();
				
				$("#listing").find(".offset").unbind();
				$("#listing").html(listing.htmlFormat());
				$("#listing").find(".offset").click(function(evt) {
					var lineNumber = parseInt(this.id.substr("offset_line_".length));
					console.log("Breakpoint on " + lineNumber);
					
					// only allow breakpoints on lines that have actual commands
					if(listing.lines[lineNumber].bytecode.length > 0) {
						$(this).toggleClass("breakpoint");
						_debugger.toggleBreakpoint(parseInt($(this).text()));
					}
				});
				
				$("#editing_windows").hide();
				$("#debugging_windows").show();
				
				emulator.reboot();
				emulator.paused = true;
				emulator.run(listing.bytecode());
				updateRegisterWindow();
			}
			
			function stopDebugger() {
				reset();
			
				$("#assemble_button").show();
				$("#debug_button").show();
			
				$("#run_button").hide();
				$("#step_button").hide();
				$("#pause_button").hide();
				$("#stop_button").hide();
				$("#reset_button").hide();
				
				$("#editing_windows").show();
				$("#debugging_windows").hide();
			}
			
			$(document).ready(function(){
				$("#assemble_button").button({ icons: { primary: "ui-icon-link" } });
				$("#debug_button").button({ icons: { primary: "ui-icon-radio-on" } });
				
				$("#run_button").button({ icons: { primary: "ui-icon-play" } }).hide();
				$("#step_button").button({ icons: { primary: "ui-icon-arrowreturnthick-1-e" } }).hide();
				$("#pause_button").button({ icons: { primary: "ui-icon-pause" } }).hide();
				$("#stop_button").button({ icons: { primary: "ui-icon-stop" } }).hide();
				$("#reset_button").button({ icons: { primary: "ui-icon-arrowrefresh-1-s" } }).hide();
				
				$("#listing").scroll(updateDebuggerLine);
				
				init();
				
				//$("#source-dialog").resizable( { autoHide: true, handles: "s" });
				//$("#assembly-dialog").resizable( { autoHide: true, handles: "n" });
			});
			
			function pauseDebugger() {
				_debugger.pause();
			}
			
			function run() {
				_debugger.run();
				updateDebugger();
			}
			
			function step() {
				_debugger.step();
			}
			
			function reset() {
				emulator.reboot();
				emulator.paused = true;
				emulator.run(listing.bytecode());
			}
			
			
			function updateDebugger() {
				console.log("updateDebugger");
				if(emulator.paused) {
					$("#debugger_line").show();
					
					ensureDebuggerLineVisible();
					updateDebuggerLine();
					
					updateRegisterWindow();
					updateMemoryWindow();
					
					$("#pause_button").hide();
					$("#step_button").show();
					$("#run_button").show();
				}
				else {
					$("#pause_button").show();
					$("#step_button").hide();
					$("#run_button").hide();
				}
			}
			
			function calculateDebuggerLine() {
				// find line from memory offset
				var location = emulator.PC.get();
				var line = 0;
				for(line = 0; line < listing.lines.length; line++) {
					if(listing.lines[line].offset >= location) {
						location = listing.lines[line].offset;
						break;
					}
				}
				// skip lines that are noops
				while(line < listing.lines.length && listing.lines[line].offset == location) {
					line++;
				}
				line--;
				
				return line;
			}
			
			function getDebuggerLineTop(line) {
				var lineHeight= 14;
				return line*lineHeight + $("#listing").position().top + 2;
			}
			
			function updateDebuggerLine() {
				var top = getDebuggerLineTop(calculateDebuggerLine()) - $("#listing").scrollTop()
				$("#debugger_line").css("top", top + "px");
			}
			
			function ensureDebuggerLineVisible() {
				var top = getDebuggerLineTop(calculateDebuggerLine());
				console.log("ensureDebuggerLineVisible | current: " + $("#listing").scrollTop() + " | dest: " + top);
				if(top > $("#listing").scrollTop() + $("#listing").height() - 14 || top < $("#listing").scrollTop()) {
					$("#listing").scrollTop(Math.max(top - $("#listing").height()/2, 0));
				}
			}
			
			
			function updateRegisterWindow() {
				for(var reg in emulator.Registers) {
					var val = Utils.hex2(emulator.Registers[reg].get());
					val += "&nbsp;&nbsp;"
					val += "[" + Utils.hex2(emulator.RAM[emulator.Registers[reg].get()] || 0) + "]";
					
					var div = $("#register-" + reg).find(".register-value");
					if(div.html() != val)
						div.addClass("changed");
					else
						div.removeClass("changed");
					div.html(val);
				}
			}
			
			function updateMemoryWindow() {
				var startOffset = 0; //
				
				var memHtml = "";
				for(var i = 0; i < 64; i++) {
					memHtml += "<div class=\"memory_offset\">" + Utils.hex2(startOffset + i*8) + "</div>";
					memHtml += "<div class=\"memory_line\">"
					for(var j = 0; j < 8; j++) {
						memHtml += Utils.hex2(emulator.RAM[startOffset + i*8 + j] || 0) + " ";
					}
					memHtml += "</div><div class=\"clear\"></div>";
				}
				$("#memory").html(memHtml);
			}
		</script>
	</head>
	<body>
		<div id="toolbar" class="ui-widget-header ui-corner-all">
			<button id="assemble_button" onclick="assemble()">Assemble</button>
			<button id="debug_button" onclick="startDebugger()">Debug</button>
			<button id="run_button" onclick="run()">Run</button>
			<button id="step_button" onclick="step()">Step</button>
			<button id="stop_button" onclick="stopDebugger()">Stop</button>
			<button id="pause_button" onclick="pauseDebugger()">Pause</button>
			<button id="reset_button" onclick="reset()">Reset</button>
		</div>
		
		<div>
		
			<div class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="right:0px; height:255px; top: 50px;">
				<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
					<span class="ui-dialog-title">Emulator</span>
				</div>
				<div style="height: auto; width: auto;" class="ui-dialog-content ui-widget-content">
					<div id="monitor"></div>
				</div>
			</div>
			
			
			<div id="editing_windows">
				<div id="source-dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="right: 310px; left: 0px; bottom: 220px; top: 50px; width: auto;">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
						<span class="ui-dialog-title">Source</span>
					</div>
					<div id="editor" class="ui-dialog-content ui-widget-content"></div>
				</div>
				
				<div id="assembly-dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="left: 0px; bottom: 0px; height: 210px; right: 310px; width: auto;">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
					  <span class="ui-dialog-title">Assembly Result</span>
					</div>
					<div id="assembly" class="dialog_contents ui-dialog-content ui-widget-content scrolling_contents"></div>
				</div>
				
				<div id="ouput-dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="right:0px; width: 300px; bottom: 0px; top: 310px;">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
					  <span class="ui-dialog-title">Output</span>
					</div>
					<div id="output" class="ui-dialog-content ui-widget-content dialog_contents scrolling_contents"></div>
				</div>
			
			</div>
			
			<div id="debugging_windows" style="display: none">
				<div id="listing-dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="right: 310px; left: 0px; bottom: 220px; top: 50px; width: auto;">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
						<span class="ui-dialog-title">Listing</span>
					</div>
					<div id="listing"  
						class="ui-dialog-content ui-widget-content dialog_contents scrolling_contents"></div>
						
					<div id="debugger_line"></div>
				</div>
				
				<div id="memory-dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="left: 0px; bottom: 0px; height: 210px; right: 310px; width: auto;">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
					  <span class="ui-dialog-title">Memory</span>
					</div>
					<div id="memory" class="dialog_contents ui-dialog-content ui-widget-content scrolling_contents"></div>
				</div>
				
				<div id="registers-dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all" style="right:0px; width: 300px; bottom: 0px; top: 310px;">
					<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
					  <span class="ui-dialog-title">Registers</span>
					</div>
					<div id="registers" class="ui-dialog-content ui-widget-content dialog_contents scrolling_contents">
						<div id="register-A">
							<div class="register-name">A:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-B">
							<div class="register-name">B:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-C">
							<div class="register-name">C:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-X">
							<div class="register-name">X:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-Y">
							<div class="register-name">Y:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-Z">
							<div class="register-name">Z:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-I">
							<div class="register-name">I:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-J">
							<div class="register-name">J:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-SP">
							<div class="register-name">SP:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-PC">
							<div class="register-name">PC:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-EX">
							<div class="register-name">EX:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
						<div id="register-IA">
							<div class="register-name">IA:</div>
							<div class="register-value">0x0000</div>
							<div class="clear"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		
		
		
		
	</body>
</html>